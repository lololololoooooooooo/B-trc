<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin | IoT Battery Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
    fieldset{margin-bottom:18px;padding:12px}
    label{display:block;margin:.35rem 0 .2rem}
    input,textarea{width:420px;max-width:95%;padding:8px}
    button{margin-top:10px;padding:8px 12px}
    .row{display:flex;gap:28px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:8px;padding:12px;flex:1;min-width:280px}
    code{background:#f6f8fa;padding:2px 4px;border-radius:4px}
    .ok{color:#2e7d32}.err{color:#b00020}
    textarea{height:84px}
    nav a{margin-right:12px}
    #miniMap{height:360px;border:1px solid #ddd;border-radius:8px;margin-top:12px}
  </style>
</head>
<body>
  <nav>
    <a href="/index.html">Home</a>
    <a href="/map.html">Map</a>
    <a href="/admin.html">Admin</a>
  </nav>
  <h1>Admin</h1>
  <p>
    Provisioning actions (create user, assign device) use <code>ADMIN_TOKEN</code>.
    User login below is with the email/password you create for users.
  </p>

  <div class="row">
    <div class="card">
      <h3>Login (get JWT)</h3>
      <label>Email</label>
      <input id="loginEmail" placeholder="user@example.com"/>
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="password"/>
      <button onclick="login()">Login</button>
      <div id="loginMsg"></div>
      <p>JWT (copy to test user routes):</p>
      <textarea id="jwt" readonly></textarea>
    </div>

    <div class="card">
      <h3>Upsert User</h3>
      <label>Admin Token</label>
      <input id="admTok" placeholder="ADMIN_TOKEN"/>
      <label>Email</label>
      <input id="uEmail" placeholder="user@example.com"/>
      <label>Password</label>
      <input id="uPass" type="password" placeholder="password"/>
      <label>Role</label>
      <input id="uRole" placeholder="member or admin"/>
      <button onclick="upsertUser()">Save User</button>
      <button onclick="createDefaultAdmin()" style="margin-left:6px">Quick: Create default admin</button>
      <div id="upsertMsg"></div>
      <p style="font-size:.9rem;color:#555">Default admin creds used by this button: <code>admin@123</code> / <code>asd123</code></p>
    </div>

    <div class="card">
      <h3>Assign Device to User</h3>
      <label>Admin Token</label>
      <input id="admTok2" placeholder="ADMIN_TOKEN"/>
      <label>User Email</label>
      <input id="aEmail" placeholder="user@example.com"/>
      <label>Device ID</label>
      <input id="aDev" placeholder="batt-001"/>
      <button onclick="assignDevice()">Assign</button>
      <div id="assignMsg"></div>
    </div>

    <div class="card">
      <h3>Create Device + PowerShell command</h3>
      <label>Admin Token</label>
      <input id="admTok3" placeholder="ADMIN_TOKEN"/>
      <label>Device ID</label>
      <input id="cDev" placeholder="batt-005"/>
      <label>Name (optional)</label>
      <input id="cName" placeholder="My Pack"/>
      <label>Lat (optional)</label>
      <input id="cLat" type="number" step="0.00000001" placeholder="0"/>
      <label>Lon (optional)</label>
      <input id="cLon" type="number" step="0.00000001" placeholder="0"/>
      <button onclick="createDevice()">Create</button>
      <div id="createMsg"></div>
      <p>PowerShell one‑liner:</p>
      <textarea id="psCmd" readonly></textarea>
    </div>

    <div class="card">
      <h3>Per-device Secret (ID + password)</h3>
      <label>Admin Token</label>
      <input id="admTok4" placeholder="ADMIN_TOKEN"/>
      <label>Device ID</label>
      <input id="sDev" placeholder="batt-001"/>
      <label>Secret (optional, leave blank to auto-generate)</label>
      <input id="sSecret" placeholder="auto-generate"/>
      <button onclick="setSecret()">Set secret</button>
      <div id="secretMsg"></div>
      <p>Provide this secret to the device. Then send it in header <code>X-Device-Token</code> with that device’s ID.</p>
    </div>
  </div>

  <h3>Devices overview</h3>
  <div id="miniMap"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    async function login(){
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPass').value;
      const msg = document.getElementById('loginMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/auth-login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        document.getElementById('jwt').value = data.token || '';
        msg.innerHTML = '<span class="ok">Logged in</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
    async function upsertUser(){
      const token = document.getElementById('admTok').value.trim();
      const email = document.getElementById('uEmail').value.trim();
      const password = document.getElementById('uPass').value;
      const role = document.getElementById('uRole').value.trim()||'member';
      const msg = document.getElementById('upsertMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/admin-upsert-user',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify({email,password,role})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        msg.innerHTML = '<span class="ok">Saved '+data.user.email+'</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
    async function createDefaultAdmin(){
      const token = document.getElementById('admTok').value.trim();
      const email = 'admin@123';
      const password = 'asd123';
      const role = 'admin';
      const msg = document.getElementById('upsertMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/admin-upsert-user',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify({email,password,role})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        msg.innerHTML = '<span class="ok">Default admin created</span>';
        // Prefill login box for convenience
        document.getElementById('loginEmail').value = email;
        document.getElementById('loginPass').value = password;
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
    async function assignDevice(){
      const token = document.getElementById('admTok2').value.trim();
      const email = document.getElementById('aEmail').value.trim();
      const device_id = document.getElementById('aDev').value.trim();
      const msg = document.getElementById('assignMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/admin-assign-device',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify({email,device_id})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        msg.innerHTML = '<span class="ok">Assigned</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
    async function createDevice(){
      const token = document.getElementById('admTok3').value.trim();
      const device_id = document.getElementById('cDev').value.trim();
      const name = document.getElementById('cName').value.trim();
      const lat = document.getElementById('cLat').value;
      const lon = document.getElementById('cLon').value;
      const msg = document.getElementById('createMsg');
      msg.textContent = '';
      try{
        const body = { device_id };
        if(name) body.name = name;
        if(lat) body.lat = parseFloat(lat);
        if(lon) body.lon = parseFloat(lon);
        const res = await fetch('/.netlify/functions/admin-create-device',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify(body)});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        document.getElementById('psCmd').value = data.powershell || '';
        msg.innerHTML = '<span class="ok">Device ready: '+data.device_id+'</span>';
        // refresh map
        loadMap();
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }

    async function setSecret(){
      const token = document.getElementById('admTok4').value.trim();
      const device_id = document.getElementById('sDev').value.trim();
      const secret = document.getElementById('sSecret').value.trim();
      const msg = document.getElementById('secretMsg');
      msg.textContent = '';
      try{
        const body = { device_id }; if(secret) body.secret = secret;
        const res = await fetch('/.netlify/functions/admin-set-device-secret',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify(body)});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        msg.innerHTML = '<span class="ok">Secret set. New secret: '+data.secret+'</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }

    // Map: show all devices
    let map, markers=[];
    async function loadMap(){
      try{
        const res = await fetch('/.netlify/functions/latest');
        const rows = await res.json();
        if(!map){
          map = L.map('miniMap').setView([20,0],2);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
        }
        markers.forEach(m=>map.removeLayer(m)); markers=[];
        const bounds = [];
        rows.forEach(d=>{
          if(d.lat!=null && d.lon!=null){
            const m = L.marker([d.lat, d.lon]).addTo(map).bindPopup(`${d.device_id}`);
            markers.push(m); bounds.push([d.lat, d.lon]);
          }
        });
        if(bounds.length){ map.fitBounds(bounds, { padding:[20,20] }); }
      }catch(e){ console.error(e); }
    }
    loadMap();
  </script>
</body>
</html>
