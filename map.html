<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IoT Battery Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css"/>
  <style>
    /* ---- Layout ---- */
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #sidebar{
      width:280px;
      height:100vh;
      overflow-y:auto;
      background:#f7f7f7;
      border-right:1px solid #ddd;
      padding:12px;
      box-sizing:border-box;
    }
    #map{height:100vh;margin-left:280px}
    .device-card{
      border:1px solid #ccc;
      border-radius:6px;
      padding:8px 10px;
      margin-bottom:8px;
      background:#fff;
      cursor:pointer;
    }
    .device-card h4{margin:0 0 4px}
    .device-card p{margin:2px 0;font-size:.85rem}
    .highlight{background:#e6ffe6;border-color:#2e7d32}
    .error-message{color:red;font-weight:bold}
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <h2>Devices</h2>
    <div id="deviceList">Loading…</div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};          // device_id → marker
    const cards   = {};          // device_id → card DOM node

    async function refresh() {
      try {
        const res = await fetch('/.netlify/functions/latest');
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const rows = await res.json();          // newest first
        const list = document.getElementById('deviceList');
        list.innerHTML = '';                   // clear old list

        // Clear old markers
        Object.values(markers).forEach(marker => map.removeLayer(marker));
        Object.keys(markers).forEach(key => delete markers[key]);
        Object.keys(cards).forEach(key => delete cards[key]);

        if (!Array.isArray(rows) || rows.length === 0) {
          list.innerHTML = '<p>No devices found</p>';
          return;
        }

        rows.forEach(r => {
          const d = r.data || r;               // handle both KV & Fauna shapes
          
          // Ensure required fields exist
          if (!d.device_id || !d.lat || !d.lon) {
            console.warn('Device missing required fields:', d);
            return;
          }
          
          if (!markers[d.device_id]) {
            // create marker
            markers[d.device_id] = L.marker([d.lat, d.lon])
              .addTo(map)
              .bindPopup(`${d.device_id}<br>${d.soc || 'N/A'}%<br>${d.v || 'N/A'} V`);
            // create card
            const card = document.createElement('div');
            card.className = 'device-card';
            card.id        = `card-${d.device_id}`;
            card.innerHTML = `
              <h4>${d.device_id}</h4>
              <p><strong>SOC:</strong> ${d.soc || 'N/A'}%</p>
              <p><strong>Voltage:</strong> ${d.v || 'N/A'} V</p>
              <p><strong>Temp:</strong> ${d.t || 'N/A'} °C</p>
              <p><em>Last seen: ${new Date((d.ts || Date.now()) * 1000).toLocaleTimeString()}</em></p>
            `;
            card.onclick = () => {
              map.setView([d.lat, d.lon], 13);
              markers[d.device_id].openPopup();
              // highlight card
              Object.values(cards).forEach(c => c.classList.remove('highlight'));
              card.classList.add('highlight');
            };
            list.appendChild(card);
            cards[d.device_id] = card;
          } else {
            // update marker & card
            markers[d.device_id].setLatLng([d.lat, d.lon]);
            const c = cards[d.device_id];
            if (c) {
              c.querySelector('p:nth-of-type(1)').textContent = `SOC: ${d.soc || 'N/A'}%`;
              c.querySelector('p:nth-of-type(2)').textContent = `Voltage: ${d.v || 'N/A'} V`;
              c.querySelector('p:nth-of-type(3)').textContent = `Temp: ${d.t || 'N/A'} °C`;
              c.querySelector('em').textContent = `Last seen: ${new Date((d.ts || Date.now()) * 1000).toLocaleTimeString()}`;
            }
          }
        });
      } catch (error) {
        console.error('Error refreshing devices:', error);
        const list = document.getElementById('deviceList');
        list.innerHTML = `<p class="error-message">Error loading devices: ${error.message}</p>`;
        
        // Retry after 5 seconds
        setTimeout(refresh, 5000);
      }
    }

    refresh();
    setInterval(refresh, 15000);   // auto-refresh every 15 s
  </script>
</body>
</html>
