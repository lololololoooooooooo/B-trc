<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin | IoT Battery Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
    fieldset{margin-bottom:18px;padding:12px}
    label{display:block;margin:.35rem 0 .2rem}
    input{width:320px;max-width:95%;padding:8px}
    button{margin-top:10px;padding:8px 12px}
    .row{display:flex;gap:28px;flex-wrap:wrap}
    .card{border:1px solid #ddd;border-radius:8px;padding:12px}
    code{background:#f6f8fa;padding:2px 4px;border-radius:4px}
    .ok{color:#2e7d32}.err{color:#b00020}
  </style>
</head>
<body>
  <h1>Admin</h1>
  <p>Use your <code>ADMIN_TOKEN</code> for admin APIs. Use <code>auth-login</code> to get a user JWT.</p>

  <div class="row">
    <div class="card">
      <h3>Login (get JWT)</h3>
      <label>Email</label>
      <input id="loginEmail" placeholder="user@example.com"/>
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="password"/>
      <button onclick="login()">Login</button>
      <div id="loginMsg"></div>
      <p>JWT (copy to test user routes):</p>
      <textarea id="jwt" rows="4" cols="60" readonly></textarea>
    </div>

    <div class="card">
      <h3>Upsert User</h3>
      <label>Admin Token</label>
      <input id="admTok" placeholder="ADMIN_TOKEN"/>
      <label>Email</label>
      <input id="uEmail" placeholder="user@example.com"/>
      <label>Password</label>
      <input id="uPass" type="password" placeholder="password"/>
      <label>Role</label>
      <input id="uRole" placeholder="member or admin"/>
      <button onclick="upsertUser()">Save User</button>
      <div id="upsertMsg"></div>
    </div>

    <div class="card">
      <h3>Assign Device to User</h3>
      <label>Admin Token</label>
      <input id="admTok2" placeholder="ADMIN_TOKEN"/>
      <label>User Email</label>
      <input id="aEmail" placeholder="user@example.com"/>
      <label>Device ID</label>
      <input id="aDev" placeholder="batt-001"/>
      <button onclick="assignDevice()">Assign</button>
      <div id="assignMsg"></div>
    </div>
  </div>

  <script>
    async function login(){
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPass').value;
      const msg = document.getElementById('loginMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/auth-login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        document.getElementById('jwt').value = data.token || '';
        msg.innerHTML = '<span class="ok">Logged in</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
    async function upsertUser(){
      const token = document.getElementById('admTok').value.trim();
      const email = document.getElementById('uEmail').value.trim();
      const password = document.getElementById('uPass').value;
      const role = document.getElementById('uRole').value.trim()||'member';
      const msg = document.getElementById('upsertMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/admin-upsert-user',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify({email,password,role})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        msg.innerHTML = '<span class="ok">Saved '+data.user.email+'</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
    async function assignDevice(){
      const token = document.getElementById('admTok2').value.trim();
      const email = document.getElementById('aEmail').value.trim();
      const device_id = document.getElementById('aDev').value.trim();
      const msg = document.getElementById('assignMsg');
      msg.textContent = '';
      try{
        const res = await fetch('/.netlify/functions/admin-assign-device',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify({email,device_id})});
        const data = await res.json();
        if(!res.ok){ msg.innerHTML = '<span class="err">'+(data.error||'Error')+'</span>'; return; }
        msg.innerHTML = '<span class="ok">Assigned</span>';
      }catch(e){ msg.innerHTML = '<span class="err">'+e.message+'</span>'; }
    }
  </script>
</body>
</html>
